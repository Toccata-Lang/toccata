#!/bin/bash

rm $1.out $1.tmp
echo "using toccata, not new-toc"
cp /home/jim/toccata/good-core.toc /home/jim/toccata/core.toc &&
time $TOCCATA_DIR/toccata $1 > $1.tmp &&
sed -i 's/maybe((FnArity/maybe((Vector/' $1.tmp &&

awk '/^#$/ { printf "#line %d \"%s\"\n", NR+1, "m.c"; next; } { print; }' $1.tmp > m.c &&
time $CC -g -o $1.out -I$TOCCATA_DIR -std=c99 \
     -DCHECK_MEM_LEAK=1 \
     $TOCCATA_DIR/core.c m.c \
     -lpthread -latomic &&
time ./$1.out "${@:2}"

#     -DSINGLE_THREADED=1 -DFAST_DECS=1 -DFAST_INCS=1 \
#     -DCHECK_MEM_LEAK=1 \

# time $CC -g -O3 -o $1.out -I$TOCCATA_DIR -std=c99 -DCHECK_MEM_LEAK=1 $TOCCATA_DIR/core.c m.c \
#      -lpthread -latomic &&
